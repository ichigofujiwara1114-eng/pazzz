<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>不測演算 - STAGE 4</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: #90EE90; font-family: 'Press Start 2P', cursive; box-sizing: border-box; overflow-x: hidden; }
        
        .whiteboard { 
            background: #fff; border: 4px solid #444; 
            padding: 10px; width: 92vw; max-width: 900px; min-height: 100px; 
            box-shadow: 8px 8px 0 rgba(0,0,0,0.1); margin-bottom: 20px; 
            display: flex; align-items: center; justify-content: center; 
            position: relative; overflow-x: hidden;
        }
        
        .formula-line { 
            display: flex; align-items: center; gap: 2px; 
            font-size: 2.8vw; 
            color: #333; white-space: nowrap; 
        }
        @media screen and (min-width: 800px) {
            .formula-line { font-size: 18px; }
            .special-svg { width: 24px; height: 24px; }
        }
        
        .special-svg { width: 3.5vw; height: 3.5vw; flex-shrink: 0; display: inline-block; vertical-align: middle; }
        .special-svg path, .special-svg polyline, .special-svg circle { fill: none; stroke: #333; stroke-width: 3.5; stroke-linecap: round; stroke-linejoin: round; }
        .special-svg text { font-family: 'Arial', sans-serif; font-size: 14px; fill: #333; font-weight: bold; }

        .display-container { background: #333; border: 4px solid #444; padding: 8px; width: 180px; text-align: center; margin-bottom: 10px; border-radius: 8px; }
        .display-text { color: #0f0; font-size: 20px; min-height: 20px; }
        
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 220px; }
        .key { background: #eee; border: 3px solid #444; border-radius: 6px; padding: 10px 0; font-family: inherit; font-size: 14px; cursor: pointer; box-shadow: 0 4px #999; }
        .key:active { transform: translateY(2px); box-shadow: 0 2px #999; }

        .congrats-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(144, 238, 144, 0.98); z-index: 9999; text-align: center; padding: 20px; box-sizing: border-box; }
        .congrats-title { font-family: sans-serif; font-weight: 900; font-size: 8vw; line-height: 1.3; color: #000; margin: 0; }
        .back-btn { margin-top: 50px; padding: 20px 40px; font-family: inherit; background: #000; color: #fff; border: none; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>
<div id="board" class="whiteboard"></div>
<div class="display-container"><div id="display" class="display-text"></div></div>
<div class="keypad">
    <button class="key" onclick="press(1)">1</button><button class="key" onclick="press(2)">2</button><button class="key" onclick="press(3)">3</button>
    <button class="key" onclick="press(4)">4</button><button class="key" onclick="press(5)">5</button><button class="key" onclick="press(6)">6</button>
    <button class="key" onclick="press(7)">7</button><button class="key" onclick="press(8)">8</button><button class="key" onclick="press(9)">9</button>
    <button class="key" onclick="press('-')">-</button><button class="key" onclick="press(0)">0</button><button class="key" style="background:#ff7675" onclick="clearInput()">C</button>
    <button class="key" style="background:#55efc4; grid-column: span 3;" onclick="checkAnswer()">ENTER</button>
</div>

<script>
    let step = 0;
    let input = "";

    const S2_CIR = `<div class="special-svg"><svg viewBox="0 0 40 40"><path d="M5,20 H13 M27,20 H35"/><circle cx="20" cy="20" r="7"/></svg></div>`;
    const S2_CIR_EDGES = `<div class="special-svg"><svg viewBox="0 0 40 40"><path d="M5,20 H13 M27,20 H35 M5,12 V28 M35,12 V28"/><circle cx="20" cy="20" r="7"/></svg></div>`;
    const S3_UP = '<div class="special-svg"><svg viewBox="0 0 40 40"><path d="M5,12 H35"/><path d="M10,32 L20,13 L30,32"/></svg></div>';
    const S2_ALL = '<div class="special-svg"><svg viewBox="0 0 40 40"><path d="M5,20 H35 M5,10 V30 M35,10 V30 M20,5 V35"/></svg></div>';
    const STAIRS_CUT = '<div class="special-svg"><svg viewBox="0 0 45 45"><polyline points="8,38 8,23 23,23 23,8 38,8"/></svg></div>';
    const DIAGONAL_ARROW_2 = '<div class="special-svg"><svg viewBox="0 0 45 45"><path d="M10,33 L35,8 M10,8 H35 V33"/><text x="22" y="34">2</text></svg></div>';
    const DIAGONAL_ARROW_DOWN_3 = '<div class="special-svg"><svg viewBox="0 0 45 45"><path d="M10,12 L35,37 M10,37 H35 V12"/><text x="22" y="24">3</text></svg></div>';
    const S3_DOWN = '<div class="special-svg"><svg viewBox="0 0 40 40"><path d="M10,8 L20,30 L30,8 M5,32 H35"/></svg></div>';
    const Q3_G_SIMPLE = '<div class="special-svg"><svg viewBox="0 0 40 40"><path d="M28,12 H12 V28"/></svg></div>';
    const Q3_G_EVO = '<div class="special-svg"><svg viewBox="0 0 40 40"><path d="M28,12 H12 V28 M8,28 H16 M28,8 V16"/></svg></div>';
    const Q4_V_BAR = '<div class="special-svg"><svg viewBox="0 0 40 40"><path d="M10,12 L20,30 L30,12 M5,32 H35"/></svg></div>';
    const Q4_S3UP_EDGES = '<div class="special-svg"><svg viewBox="0 0 40 40"><path d="M5,12 H35 M5,8 V16 M35,8 V16"/><path d="M10,32 L20,13 L30,32"/></svg></div>';

    const questions = [
        { html: `<div class="formula-line">3 ${S3_UP} 11 ${S2_CIR} 6 ${S2_ALL} 1 = ?</div>`, ans: "4106" },
        { html: `<div class="formula-line">4 ${STAIRS_CUT.replace('38,8','38,8 38,18')} 3-5 2 ${DIAGONAL_ARROW_2} 4 = ?</div>`, ans: "18" },
        { html: `<div class="formula-line">2-3 ${Q3_G_SIMPLE} ${S3_DOWN} ${S2_CIR_EDGES} 4-4 ${Q3_G_EVO} 1-4 = ?</div>`, ans: "251" },
        { html: `<div class="formula-line">7 ${Q4_V_BAR} ${S2_ALL} ${Q4_S3UP_EDGES} 5 2 1 ${DIAGONAL_ARROW_2} 8 = ?</div>`, ans: "325" },
        // 第5問：数値を4-85に変更
        { html: `<div class="formula-line">2-6 ${S3_UP} ${STAIRS_CUT} ${S2_ALL} ${DIAGONAL_ARROW_DOWN_3} ${S2_ALL} 4-85 ${S2_CIR} ${Q4_V_BAR} 19-7 = ?</div>`, ans: "39-7" }
    ];

    function load() {
        input = ""; document.getElementById("display").innerText = "";
        document.getElementById("board").innerHTML = questions[step].html;
    }
    function press(n) { input += n; document.getElementById("display").innerText = input; }
    function clearInput() { input = ""; document.getElementById("display").innerText = ""; }
    function checkAnswer() {
        if (input === questions[step].ans) {
            step++;
            if(step >= questions.length) {
                const overlay = document.createElement('div');
                overlay.className = 'congrats-overlay';
                overlay.innerHTML = `<div class="congrats-title">おめでとう！<br>あなたは不測演算を<br>クリアした！</div><button class="back-btn" onclick="location.href='index.html?clear=4'">MENU</button>`;
                document.body.appendChild(overlay);
            } else { load(); }
        } else { step = 0; load(); }
    }
    load();
</script>
</body>
</html>
